# 🧩 Discord 揪團機器人

一個完整的 Discord 機器人，支援兩種揪團模式：**時間調查**（投票找時間）與**指定時間揪團**（報名參加）。

## ✨ 功能特色

### 🗳️ 時間調查模式
- 📅 **日曆複選功能** - 透過下拉選單一次選擇多個日期
- 🔍 **智慧推薦** - 自動計算所有人都有空的日期並推薦
- 📊 **即時統計** - 查看所有參與者選擇的日期
- ⚡ **快速建立** - 月份留空自動使用當前月份

### 🎯 指定時間揪團
- ⏰ **指定時間** - 發起人直接設定活動日期與時間
- ✅ **一鍵報名** - 參加者點擊按鈕即可參加/取消
- 👥 **參加名單** - 即時顯示已報名人數與名單
- 🔔 **即時更新** - 報名後自動更新參加人數

### 🎨 通用功能
- 🎯 **圖形化介面** - 使用下拉選單、按鈕，無需輸入複雜指令
- 💾 **資料持久化** - 使用 JSON 儲存活動資料
- 🗑️ **權限管理** - 只有建立者可刪除活動

### 📄 檔案轉換功能（NEW！）
- 🔄 **自動轉換** - @ Bot 並上傳檔案即可自動轉 PDF
- 📋 **多格式支援** - 支援 .doc、.docx、.pptx
- 🌍 **跨平台部署** - Windows、Linux、Mac、Docker 都能用
- 🔧 **智慧備援** - 自動嘗試多種轉換方法
- ✅ **免費方案** - 使用 LibreOffice（開源免費）

## 🚀 快速開始

### Windows 部署

```bash
# 1. 安裝依賴
pip install -r requirements.txt

# 2. 安裝 LibreOffice（檔案轉換功能）
# 下載：https://www.libreoffice.org/download/download/

# 3. 設定環境變數
echo DISCORD_BOT_TOKEN=你的_Token > .env

# 4. 啟動 Bot
python main.py
```

### Linux 部署

```bash
# 1. 安裝依賴
sudo apt update
sudo apt install python3 python3-pip libreoffice -y
pip3 install -r requirements.txt

# 2. 設定環境變數
nano .env  # 加入 DISCORD_BOT_TOKEN=你的_Token

# 3. 啟動 Bot
python3 main.py
```

### Docker 部署（推薦用於生產環境）

```bash
# 1. 建立 .env 檔案
echo "DISCORD_BOT_TOKEN=你的_Token" > .env

# 2. 使用 Docker Compose 啟動
docker-compose up -d

# 3. 查看日誌
docker-compose logs -f
```

### 建立 Discord Bot

1. 前往 [Discord Developer Portal](https://discord.com/developers/applications)
2. 建立新應用程式
3. 在 Bot 頁面建立 Bot 並複製 Token
4. 在 OAuth2 > URL Generator 選擇：
   - Scopes: `bot`, `applications.commands`
   - Bot Permissions: `Send Messages`, `Embed Links`, `Use Slash Commands`, `Attach Files`
5. 使用生成的 URL 邀請 Bot 到伺服器

## 📖 使用說明

### 指令列表

| 指令 | 說明 |
|------|------|
| `/create` | 建立時間調查活動（投票找時間） |
| `/schedule` | 建立指定時間揪團（報名參加） |
| `/events` | 列出所有活動 |
| `/show <活動名稱>` | 顯示活動詳情 |

### 使用流程

## 🗳️ 模式一：時間調查（找大家都有空的時間）

#### 步驟 1：建立活動
1. 輸入 `/create`
2. 在彈出的表單中填寫：
   - **活動名稱**（必填）- 例如：火鍋聚
   - **活動說明**（可選）- 例如：吃飯聊天
   - **目標月份**（可選）- 格式：`2025-10`（留空則使用當前月份）
3. 送出後會顯示活動卡片

#### 步驟 2：選擇日期（下拉複選）
1. 點擊「🕒 選擇可參加時間」按鈕
2. 從下拉選單選擇日期（**可複選**）
   - 若該月超過 25 天，會分成兩個選單（1-15 日 / 16-31 日）
   - 每個選項顯示：`10月12日 (週四)`
3. 選完後點擊「✅ 確認選擇」
4. 已選日期會自動儲存

#### 步驟 3：查看統計
- 點擊「📊 查看統計」查看所有參與者選擇的日期

#### 步驟 4：取得推薦
- 點擊「🔍 自動推薦日期」獲得所有人都有空的日期

#### 步驟 5：刪除活動
- 點擊「🗑️ 刪除活動」（僅限建立者）

---

## 🎯 模式二：指定時間揪團（直接報名）

#### 步驟 1：建立揪團
1. 輸入 `/schedule`
2. 在彈出的表單中填寫：
   - **活動名稱**（必填）- 例如：週五火鍋聚
   - **活動說明**（可選）- 例如：吃到飽
   - **日期**（必填）- 格式：`2025-10-12`
   - **時間**（必填）- 格式：`18:00`
3. 送出後會顯示揪團卡片，包含：
   - 🧑‍💼 發起人
   - 📅 活動時間
   - 👥 參加人數

#### 步驟 2：報名參加
- 點擊「✅ 我要參加」按鈕即可報名
- 卡片上的參加人數會即時更新

#### 步驟 3：取消參加
- 點擊「❌ 取消參加」按鈕即可取消

#### 步驟 4：查看名單
- 點擊「👥 查看參加者」查看完整報名名單

#### 步驟 5：刪除揪團
- 點擊「🗑️ 刪除活動」（僅限建立者）

---

## 🎮 功能示範

### 模式一示範：時間調查
```
/create
→ 活動名稱：火鍋聚
→ 目標月份：（留空 = 當月）
→ 顯示活動卡片

點擊「🕒 選擇可參加時間」
→ 複選：10月12日、10月13日、10月15日
→ 確認選擇
✅ 已新增 3 個日期

點擊「🔍 自動推薦日期」
→ 顯示共同日期：10月13日、10月15日
```

### 模式二示範：指定時間揪團
```
/schedule
→ 活動名稱：週五火鍋聚
→ 日期：2025-10-12
→ 時間：18:00
→ 顯示揪團卡片

[其他人看到]
🎉 揪團：週五火鍋聚
🧑‍💼 發起人：余益
📅 活動時間：2025年10月12日 18:00
👥 參加人數：0 人

點擊「✅ 我要參加」
→ 參加人數變為 1 人

點擊「👥 查看參加者」
→ 顯示：
• 小明
• 小華
```

## 🏗️ 專案結構

```
discord_whatTimeToPlay/
├── bot.py                # 主程式
├── requirements.txt      # Python 依賴
├── .env.example         # 環境變數範例
├── .env                 # 環境變數（需自行建立）
├── .gitignore           # Git 忽略檔案
├── events.json          # 活動資料（自動生成）
└── README.md            # 說明文件
```

## 🔧 技術細節

### 核心技術
- **discord.py 2.3+** - Discord API 函式庫
- **discord.ui** - 互動式 UI 元件（Button, Modal, View）
- **app_commands** - Slash 指令支援
- **calendar 模組** - 產生月曆資料
- **JSON** - 資料持久化

### 核心 UI 元件

| 元件 | 說明 |
|------|------|
| `CreateEventModal` | 時間調查表單（月份可留空） |
| `CreateScheduledEventModal` | 指定時間揪團表單 |
| `CalendarView` | 日期選擇下拉選單（支援複選） |
| `EventControlView` | 時間調查控制面板（4 按鈕） |
| `ScheduledEventView` | 指定時間揪團介面（4 按鈕） |

### 資料結構

```json
{
  "火鍋聚": {
    "event_type": "availability",
    "creator": 1234567890123456,
    "description": "吃飯聊天",
    "target_month": "2025-10",
    "created_at": "2025-10-08T18:00:00",
    "participants": {
      "余益": [
        {"date": "2025-10-12"},
        {"date": "2025-10-13"}
      ],
      "小明": [
        {"date": "2025-10-13"}
      ]
    }
  },
  "週五火鍋聚": {
    "event_type": "scheduled",
    "creator": 1234567890123456,
    "description": "吃到飽",
    "scheduled_time": "2025-10-12T18:00",
    "created_at": "2025-10-08T18:00:00",
    "participants": [
      9876543210987654,
      1111222233334444
    ]
  }
}
```

### 演算法

**共同日期計算**（`calculate_common_dates` 函數）：
1. 取得所有參與者的日期集合
2. 使用 `set.intersection()` 計算交集
3. 回傳所有人都選擇的日期（排序）

## 📚 完整文檔

### 核心功能
- 📖 [主要 README](./README.md) - 本文檔

### 檔案轉換功能
- 📄 [檔案轉換說明](./FILE_CONVERTER_README.md) - 功能介紹與技術細節
- 🚀 [快速開始](./QUICK_START_CONVERTER.md) - 5分鐘快速設定
- 🔧 [疑難排解](./TROUBLESHOOTING.md) - 常見問題與解決方案

### 部署指南
- 🌐 [跨平台部署指南](./DEPLOYMENT_GUIDE.md) - Windows、Linux、Docker、雲端部署

## 🔮 未來擴充

### 揪團功能
- [ ] 指定時間揪團增加時段選擇
- [ ] 時區支援
- [ ] 週期性活動（每週/每月）
- [ ] 匯出至 Google Calendar (.ics)
- [ ] 活動提醒（DM 通知）
- [ ] Web 介面（視覺化日曆）
- [ ] 投票功能（從推薦日期投票）
- [ ] 多月份選擇
- [ ] 參加人數上限設定
- [ ] 多語言支援

### 檔案轉換功能
- [ ] 支援 .xlsx (Excel) 轉換
- [ ] 支援 .odt、.odp (OpenDocument)
- [ ] PDF 壓縮選項
- [ ] 批次轉換優化
- [ ] 自訂 PDF 設定（頁面大小、方向）
- [ ] 轉換進度顯示

## 📝 常見問題

### Q: Bot 沒有回應？
A: 確認 Bot 是否有正確啟動，並檢查是否已同步 Slash 指令（啟動時會顯示）

### Q: 如何快速建立當月活動？
A: 在「目標月份」欄位留空，系統會自動使用當前月份

### Q: 可以一次選擇多個日期嗎？
A: 可以！在下拉選單中按住 Ctrl（Windows）或 Cmd（Mac）點擊多個日期

### Q: 為什麼下拉選單沒有反應？
A: Discord View 有 timeout 限制（預設 300 秒），超時後需重新點擊「🕒 選擇可參加時間」

### Q: 可以選擇多個月份嗎？
A: 目前一個活動只支援單一月份，如需跨月請建立多個活動

### Q: 找不到共同日期？
A: 表示參與者選擇的日期沒有重疊，請調整選擇或增加更多日期

### Q: 兩種模式有什麼差別？
A:
- **時間調查** (`/create`)：用於找出大家都有空的時間，適合還沒決定時間的活動
- **指定時間揪團** (`/schedule`)：時間已確定，讓大家報名參加，適合固定時間的活動

### Q: 可以重複參加嗎？
A: 指定時間揪團中，每人只能參加一次。若誤按可使用「❌ 取消參加」

### Q: 時間調查可以選擇具體時段嗎？
A: 目前時間調查只支援日期選擇，不支援時段

### Q: 活動資料會保留嗎？
A: 會，所有資料儲存在 `events.json`，除非手動刪除

## 📄 授權

MIT License

## 👥 貢獻

歡迎提交 Issue 或 Pull Request！

---

**製作者**：AI Assistant
**版本**：1.0.0
**最後更新**：2025-10-08
